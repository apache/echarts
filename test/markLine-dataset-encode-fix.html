<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>MarkLine with Dataset and Encode - Bug Fix Test</title>
        <script src="lib/simpleRequire.js"></script>
        <script src="lib/config.js"></script>
    </head>
    <body>
        <style>
            html, body {
                margin: 0;
                padding: 0;
                font-family: Arial, sans-serif;
            }
            #info {
                padding: 20px;
                background: #f0f0f0;
                border-bottom: 1px solid #ccc;
            }
            #main {
                width: 100%;
                height: 600px;
            }
        </style>
        <div id="info">
            <h2>MarkLine with Dataset + Encode Test</h2>
            <p>This test reproduces the issue where markLine fails with "Cannot read properties of undefined (reading 'ordinalMeta')"
               when using dataset with encode on a candlestick chart.</p>
            <p><strong>Expected:</strong> Chart renders without errors and displays the markLine.</p>
        </div>
        <div id="main"></div>
        <script>

            require([
                'echarts'
            ], function (echarts) {

                var chart = echarts.init(document.getElementById('main'));

                // Generate sample candlestick data
                var dataCount = 50;
                var data = [];
                var baseTime = new Date('2011-01-01T00:00:00Z').getTime();
                var basePrice = 4800;

                for (var i = 0; i < dataCount; i++) {
                    var time = new Date(baseTime + i * 30 * 60 * 1000).toISOString();
                    var open = basePrice + Math.random() * 200 - 100;
                    var close = open + Math.random() * 150 - 75;
                    var low = Math.min(open, close) - Math.random() * 50;
                    var high = Math.max(open, close) + Math.random() * 50;
                    var volume = Math.floor(Math.random() * 1000) + 500;

                    data.push([time, open, high, low, close, volume]);
                    basePrice = close;
                }

                var option = {
                    dataset: {
                        source: data
                    },
                    title: {
                        text: 'MarkLine with Dataset + Encode (Data Count: ' + dataCount + ')'
                    },
                    grid: [
                        {
                            left: '10%',
                            right: '10%',
                            bottom: 200
                        },
                        {
                            left: '10%',
                            right: '10%',
                            height: 80,
                            bottom: 80
                        }
                    ],
                    xAxis: [
                        {
                            type: 'time',
                            boundaryGap: false,
                            axisLine: { onZero: false },
                            splitLine: { show: false },
                            min: 'dataMin',
                            max: 'dataMax'
                        },
                        {
                            type: 'category',
                            gridIndex: 1,
                            boundaryGap: false,
                            axisLine: { onZero: false },
                            axisTick: { show: false },
                            splitLine: { show: false },
                            axisLabel: { show: false },
                            min: 'dataMin',
                            max: 'dataMax'
                        }
                    ],
                    yAxis: [
                        {
                            scale: true,
                            splitArea: {
                                show: true
                            }
                        },
                        {
                            scale: true,
                            gridIndex: 1,
                            splitNumber: 2,
                            axisLabel: { show: false },
                            axisLine: { show: false },
                            axisTick: { show: false },
                            splitLine: { show: false }
                        }
                    ],
                    dataZoom: [
                        {
                            type: 'inside',
                            xAxisIndex: [0, 1],
                            start: 0,
                            end: 100
                        },
                        {
                            show: true,
                            xAxisIndex: [0, 1],
                            type: 'slider',
                            bottom: 10,
                            start: 0,
                            end: 100
                        }
                    ],
                    series: [
                        {
                            name: "Candles",
                            type: 'candlestick',
                            encode: {
                                x: 0,
                                y: [1, 4, 3, 2]
                            },
                            markLine: {
                                symbol: ['none', 'none'],
                                data: [
                                    [
                                        {
                                            name: 'Test Line 1',
                                            xAxis: data[10][0],
                                            yAxis: 4800
                                        },
                                        {
                                            xAxis: data[40][0],
                                            yAxis: 4850
                                        }
                                    ],
                                    {
                                        name: 'Average',
                                        type: 'average'
                                    },
                                    {
                                        name: 'Max',
                                        type: 'max',
                                        label: {
                                            formatter: 'Max: {c}'
                                        }
                                    }
                                ],
                                lineStyle: {
                                    color: '#ff0000',
                                    type: 'solid'
                                },
                                label: {
                                    show: true
                                }
                            }
                        },
                        {
                            name: 'Volume',
                            type: 'bar',
                            xAxisIndex: 1,
                            yAxisIndex: 1,
                            itemStyle: {
                                color: '#7fbe9e'
                            },
                            large: true,
                            encode: {
                                x: 0,
                                y: 5
                            }
                        }
                    ]
                };

                try {
                    chart.setOption(option);
                } catch (error) {
                    console.error('Chart failed to render:', error);
                    document.getElementById('info').innerHTML += '<p style="color: red; font-weight: bold;">ERROR: ' + error.message + '</p>';
                }

            });

        </script>
    </body>
</html>
